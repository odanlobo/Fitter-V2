# Fluxo Completo do Treino Ativo

## Diagrama em Texto com Refer√™ncia de Arquivos

---

## Sum√°rio

- [Princ√≠pios-Chave](#princ√≠pios-chave)
- [Todos os Arquivos do Contexto de Treino Ativo](#todos-os-arquivos-do-contexto-de-treino-ativo)
- [Dados T√©cnicos](#dados-t√©cnicos)
- [Fluxo Detalhado do Treino Ativo](#fluxo-detalhado-do-treino-ativo)
    - [In√≠cio do Treino](#1-in√≠cio-do-treino)
    - [In√≠cio de Exerc√≠cio](#2-in√≠cio-de-exerc√≠cio)
    - [In√≠cio de S√©rie](#3-in√≠cio-de-s√©rie)
    - [Execu√ß√£o da S√©rie + Detec√ß√£o Autom√°tica de Fim de S√©rie](#4-execu√ß√£o-da-s√©rie--detec√ß√£o-autom√°tica-de-fim-de-s√©rie)
    - [Finaliza√ß√£o de S√©rie (Manual ou Autom√°tica) + Loop para Nova S√©rie](#5-finaliza√ß√£o-de-s√©rie-manual-ou-autom√°tica--loop-para-nova-s√©rie)
    - [Troca da Ordem de Exerc√≠cios ‚Äì Reatividade e Pausa/Ativa√ß√£o](#6-troca-da-ordem-de-exerc√≠cios--reatividade-e-pausaativa√ß√£o)
    - [Finaliza√ß√£o de Exerc√≠cio](#7-finaliza√ß√£o-de-exerc√≠cio)
    - [Finaliza√ß√£o de Treino](#8-finaliza√ß√£o-de-treino)
- [Fluxo T√©cnico de Dados e Pipeline de Capta√ß√£o](#fluxo-t√©cnico-de-dados-e-pipeline-de-capta√ß√£o)
- [Premium vs N√£o-Premium: Diferen√ßas no Fluxo](#premium-vs-n√£o-premium-diferen√ßas-no-fluxo)
- [Estrutura CoreData para Sensores, ML e Hist√≥rico](#estrutura-coredata-para-sensores-ml-e-hist√≥rico)
- [Observa√ß√µes Finais](#observa√ß√µes-finais)

---

## Princ√≠pios-Chave

- **Pr√©-requisito:** Ter pelo menos 1 treino criado e o usu√°rio obrigatoriamente autenticado (login conclu√≠do).
- Sincroniza√ß√£o em tempo real entre Apple Watch e iPhone via WCSession.
- UI reativa refletindo sensores, ML, permiss√µes premium em tempo real.
- Chunking eficiente: 100 amostras por chunk (50Hz execu√ß√£o, 20Hz descanso).
- Permiss√µes premium controladas via RevenueCat e publishers.
- Clean Architecture: UseCases, Services, Managers separados.
- Captura autom√°tica de localiza√ß√£o (opcional para todos).
- Persist√™ncia resiliente: upgrade premium libera acesso imediato ao hist√≥rico.
- Mudan√ßas de ordem de exerc√≠cios s√£o imediatamente refletidas no fluxo.

---

## Todos os Arquivos do Contexto de Treino Ativo

Esta se√ß√£o lista **TODOS** os arquivos envolvidos no fluxo completo de um treino ativo, organizados por categoria funcional:

### üì± **Aplica√ß√µes Principais (Entry Points)**
- `Fitter V2/iOSApp.swift` - Entry point iOS, setup global, permiss√µes
- `Fitter V2 Watch App/WatchApp.swift` - Entry point Watch, configura√ß√£o inicial

### üé® **Views e UI Components**

#### Views Principais
- `Fitter V2/Views/Home/HomeView.swift` - Tela inicial, acesso aos treinos
- `Fitter V2/Views/Workout/WorkoutView.swift` - Lista e gerenciamento de treinos
- `Fitter V2/Views/Workout/WorkoutSessionView.swift` - **[üöß A IMPLEMENTAR]** Interface principal do treino ativo
- `Fitter V2 Watch App/Views/WatchView.swift` - Interface Watch do treino
- `Fitter V2 Watch App/Views/WatchWorkoutSessionView.swift` - **[üöß A IMPLEMENTAR]** Interface espec√≠fica treino Watch
- `Fitter V2 Watch App/Views/PendingLoginView.swift` - Tela de aguardo sincroniza√ß√£o

#### Componentes de UI (Cards e Bot√µes) - Gerais
- `Fitter V2/Components/ExerciseCard.swift` - Card de exerc√≠cio na lista
- `Fitter V2/Components/WorkoutPlanCard.swift` - Card do plano de treino
- `Fitter V2/Components/ImportWorkoutCard.swift` - Card para importar treino
- `Fitter V2/Components/CreateButton.swift` - Bot√£o de criar treino
- `Fitter V2/Components/UploadButton.swift` - Bot√£o de upload
- `Fitter V2/Components/BackButton.swift` - Bot√£o de voltar

#### Componentes de UI - Treino Ativo **[üöß A IMPLEMENTAR]**
- `Fitter V2/Components/Workout/WorkoutStatusCard.swift` - Card de status geral do treino
- `Fitter V2/Components/Workout/ExerciseSessionCard.swift` - Card do exerc√≠cio ativo
- `Fitter V2/Components/Workout/SetCard.swift` - Card individual de s√©rie
- `Fitter V2/Components/Workout/RestTimerCard.swift` - Card do timer de descanso
- `Fitter V2/Components/Workout/AutoDetectionModal.swift` - Modal de detec√ß√£o autom√°tica
- `Fitter V2/Components/Workout/TimerSelectionSheet.swift` - Sheet de sele√ß√£o de timer
- `Fitter V2/Components/Workout/DecisionModal.swift` - Modal de decis√£o p√≥s-timer
- `Fitter V2/Components/Workout/MissingFieldsModal.swift` - Modal de campos obrigat√≥rios

### üß† **ViewModels (Estado Reativo)**
- `Fitter V2/ViewsModel/WorkoutSessionViewModel.swift` - ViewModel principal do treino ativo
- `Fitter V2/ViewsModel/WorkoutViewModel.swift` - ViewModel geral de treinos
- `Fitter V2/ViewsModel/ListExerciseViewModel.swift` - ViewModel da lista de exerc√≠cios
- `Fitter V2/ViewsModel/BaseViewModel.swift` - ViewModel base com funcionalidades comuns

### üîÑ **Use Cases (L√≥gica de Neg√≥cio)**
- `Shared/UseCases/StartWorkoutUseCase.swift` - Iniciar treino
- `Shared/UseCases/EndWorkoutUseCase.swift` - Finalizar treino
- `Shared/UseCases/StartExerciseUseCase.swift` - Iniciar exerc√≠cio
- `Shared/UseCases/EndExerciseUseCase.swift` - Finalizar exerc√≠cio
- `Shared/UseCases/StartSetUseCase.swift` - Iniciar s√©rie
- `Shared/UseCases/EndSetUseCase.swift` - Finalizar s√©rie
- `Shared/UseCases/UpdateDataToMLUseCase.swift` - Processamento ML dos dados
- `Shared/UseCases/FetchWorkoutUseCase.swift` - Buscar dados do treino
- `Shared/UseCases/UpdateWorkoutUseCase.swift` - Atualizar treino
- `Shared/UseCases/ReorderExerciseUseCase.swift` - Reordenar exerc√≠cios
- `Shared/UseCases/ImportWorkoutUseCase.swift` - Importar treino
- `Shared/UseCases/SyncWorkoutUseCase.swift` - Sincronizar treino

### üéõÔ∏è **Managers (Coordena√ß√£o e Estado)**
- `Shared/Manager/SessionManager.swift` - Gerenciador global da sess√£o
- `Shared/Manager/WorkoutPhaseManager.swift` - Gerenciador de fases (execu√ß√£o/descanso)
- `Shared/Manager/ConnectivityManager.swift` - Gerenciador de conectividade
- `Fitter V2/Sync/PhoneSessionManager.swift` - Sincroniza√ß√£o iPhone ‚Üî Watch
- `Fitter V2 Watch App/Managers/WatchSessionManager.swift` - Sincroniza√ß√£o Watch ‚Üî iPhone
- `Fitter V2 Watch App/Managers/MotionManager.swift` - Capta√ß√£o sensores Watch

### üîß **Services (Servi√ßos Especializados)**
- `Shared/Services/TimerService.swift` - Cron√¥metros e timers
- `Shared/Services/WorkoutDataService.swift` - Persist√™ncia de dados do treino
- `Shared/Services/CoreDataService.swift` - Servi√ßos Core Data gerais
- `Shared/Services/HealthKitManager.swift` - Integra√ß√£o HealthKit (heart rate, calorias)
- `Shared/Services/LocationManager.swift` - Capta√ß√£o de localiza√ß√£o
- `Shared/Services/MLModelManager.swift` - Processamento machine learning
- `Shared/Services/SubscriptionManager.swift` - Gerenciamento premium/assinaturas
- `Shared/Services/RevenueCatService.swift` - Integra√ß√£o RevenueCat
- `Shared/Services/ImportWorkoutService.swift` - Importa√ß√£o de treinos

### üìä **Models e Data (Estruturas de Dados)**
- `Shared/Models/SensorData.swift` - Estrutura dos dados de sensores
- `Shared/Models/MuscleGroup.swift` - Grupos musculares
- `Shared/Models/SubscriptionType.swift` - Tipos de assinatura
- `Shared/Models/WeightUnit.swift` - Unidades de peso
- `Fitter V2/Models/FirebaseExercise.swift` - Modelo exerc√≠cio Firebase

### üóÑÔ∏è **Persist√™ncia e Core Data**
- `Shared/Persistence/PersistenceController.swift` - Controlador principal Core Data
- `Shared/CoreData 2/CoreDataAdapter.swift` - Adaptador para convers√µes Core Data
- `Shared/CoreData 2/CoreDataModels.swift` - Modelos Core Data
- `Shared/CoreData 2/FitterModel.xcdatamodeld/` - Schema Core Data

### üîó **Protocolos e Interfaces**
- `Shared/Protocols/ExerciseDisplayable.swift` - Protocol para exibi√ß√£o de exerc√≠cios
- `Fitter V2/Services/Auth/AppleSignInServiceProtocol.swift` - Protocol Apple Sign-In
- `Fitter V2/Services/Auth/GoogleSignInServiceProtocol.swift` - Protocol Google Sign-In
- `Fitter V2/Services/Auth/FacebookSignInServiceProtocol.swift` - Protocol Facebook Sign-In
- `Fitter V2/Services/Auth/BiometricAuthServiceProtocol.swift` - Protocol autentica√ß√£o biom√©trica

### üåê **Network e Conectividade**
- `Shared/Network/NetworkMonitor.swift` - Monitor de conectividade de rede

### üîÑ **Sincroniza√ß√£o e Cloud**
- `Shared/Sync/CloudSyncStatus.swift` - Status da sincroniza√ß√£o cloud
- `Fitter V2/Sync/CloudSyncManager.swift` - Gerenciador sincroniza√ß√£o cloud

### üîê **Autentica√ß√£o (Pr√©-requisito)**
> **Nota:** Estes arquivos s√£o pr√©-requisitos para o treino ativo. O usu√°rio j√° deve estar autenticado antes de iniciar qualquer treino.

- `Shared/UseCases/AuthUseCase.swift` - Use case de autentica√ß√£o
- `Fitter V2/Services/AuthService.swift` - Servi√ßo principal de autentica√ß√£o
- `Fitter V2/Services/Auth/AppleSignInService.swift` - Login com Apple
- `Fitter V2/Services/Auth/GoogleSignInService.swift` - Login com Google
- `Fitter V2/Services/Auth/FacebookSignInService.swift` - Login com Facebook
- `Fitter V2/Services/Auth/BiometricAuthService.swift` - Autentica√ß√£o biom√©trica

### üóÉÔ∏è **Repository (Acesso a Dados)**
- `Fitter V2/Repository/FirestoreExerciseRepository.swift` - Repository exerc√≠cios Firestore

### üé® **Assets e Recursos**
- `Fitter V2/Assets.xcassets/` - Assets iOS (√≠cones, cores, imagens)
- `Fitter V2 Watch App/Assets.xcassets/` - Assets Watch

### ‚öôÔ∏è **Configura√ß√£o**
- `Fitter V2/Fitter V2.entitlements` - Entitlements iOS
- `Fitter V2 Watch App/Fitter V2 Watch App.entitlements` - Entitlements Watch
- `Fitter V2/GoogleService-Info.plist` - Configura√ß√£o Firebase
- `Fitter-V2-Info.plist` - Info.plist iOS
- `Fitter-V2-Watch-App-Info.plist` - Info.plist Watch

### üîß **Utilit√°rios**
- `Shared/Utilities/` - Diret√≥rio com utilit√°rios compartilhados

---

## üìã **Resumo de Arquivos por Funcionalidade**

### **Fluxo Principal do Treino Ativo:**
1. **In√≠cio:** `StartWorkoutUseCase.swift` ‚Üí `WorkoutSessionViewModel.swift` ‚Üí `WorkoutSessionView.swift`
2. **Sensores:** `MotionManager.swift` ‚Üí `WatchSessionManager.swift` ‚Üí `PhoneSessionManager.swift`
3. **Dados:** `SensorData.swift` ‚Üí `UpdateDataToMLUseCase.swift` ‚Üí `MLModelManager.swift`
4. **Persist√™ncia:** `WorkoutDataService.swift` ‚Üí `CoreDataAdapter.swift` ‚Üí `PersistenceController.swift`
5. **UI Reativa:** `WorkoutSessionViewModel.swift` ‚Üí Componentes UI ‚Üí Publishers

### **Arquivos Cr√≠ticos (N√∫cleo do Sistema):**
- `WorkoutSessionViewModel.swift` - Orquestra√ß√£o principal
- `SessionManager.swift` - Coordena√ß√£o global
- `WorkoutPhaseManager.swift` - Estado execu√ß√£o/descanso
- `MotionManager.swift` - Capta√ß√£o sensores Watch
- `PhoneSessionManager.swift` / `WatchSessionManager.swift` - Sincroniza√ß√£o
- `TimerService.swift` - Cron√¥metros e timers
- `HealthKitManager.swift` - M√©tricas vitais

### **Depend√™ncias Externas Principais:**
- **Core Data:** Persist√™ncia local (`FitterModel.xcdatamodeld`)
- **WatchConnectivity:** Sincroniza√ß√£o iPhone ‚Üî Watch
- **HealthKit:** Heart rate, calorias, m√©tricas vitais
- **CoreMotion:** Sensores de movimento (Watch)
- **RevenueCat:** Controle de assinatura premium
- **Firebase Firestore:** Exerc√≠cios e sincroniza√ß√£o cloud

### **Estado de Implementa√ß√£o:**
- ‚úÖ **Pr√©-requisitos:** Autentica√ß√£o, Use Cases, ViewModels, Managers, Services, Models
- üöß **Em Desenvolvimento:** Views espec√≠ficas de treino ativo, componentes UI
- üìã **Planejado:** Componentes avan√ßados de UI, modais, sheets

---

## Dados T√©cnicos

- Execu√ß√£o: 50Hz (0,02s), descanso: 20Hz (0,05s).  
- Sensores: acel., giro, gravidade, orienta√ß√£o, magn√©tico.
- Chunking: 100 amostras/transfer√™ncia.
- Detec√ß√£o autom√°tica de fase (MotionManager ‚Üí WorkoutPhaseManager).
- Heart rate/calorias: HealthKit, atualiza√ß√£o a cada 2s.
- Localiza√ß√£o opcional salva na sess√£o/hist√≥rico.
- Pipeline: sensores ‚Üí ML ‚Üí publishers ‚Üí ViewModel ‚Üí UI.
- Premium: RevenueCat/publishers, upgrade instant√¢neo ao hist√≥rico.
- Mudan√ßa de ordem: sempre pausa exerc√≠cio/s√©rie ativo, inicia o topo da lista.

---

## Fluxo Detalhado do Treino Ativo

> **üîê PR√â-REQUISITO OBRIGAT√ìRIO:** Todo o fluxo abaixo pressup√µe que o usu√°rio j√° est√° **autenticado e logado** no sistema. A autentica√ß√£o √© um pr√©-requisito, n√£o parte do fluxo de treino ativo.

### 1. **In√≠cio do Treino**

- Usu√°rio toca "Iniciar Treino" (pode ser na HomeView pelo WorkoutStatusCard ou pelo WorkoutPlanCard):

- iPhone/Watch: Trigger inicia StartWorkoutUseCase.swift
    - Cria CDCurrentSession (WorkoutDataService/CoreDataAdapter)
    - Inicializa cron√¥metro global (TimerService.swift)
    - Inicia sensores (MotionManager.swift)
    - Inicia WorkoutPhaseManager.swift
    - Sincroniza contexto com WatchSessionManager.swift
    - Inicia captura cont√≠nua de frequ√™ncia card√≠aca e calorias:
        - HealthKitManager configura HKAnchoredObjectQuery para heartRate (BPM) e inicia coleta cont√≠nua.
        - HealthKitManager configura HKLiveWorkoutBuilder/HKLiveWorkoutDataSource para activeEnergyBurned (kcal).
        - Cada nova amostra recebida atualiza arrays tempor√°rios em mem√≥ria:
            - heartRateTimeline: [timestamp: Double, value: Double]
            - caloriesTimeline: [timestamp: Double, value: Double]

- Sequ√™ncia autom√°tica:
    - Executa StartExerciseUseCase.swift para o PRIMEIRO exerc√≠cio da lista em exerciseListSection
    - Imediatamente executa StartSetUseCase.swift para a PRIMEIRA s√©rie do exerc√≠cio ativo

- UI (WorkoutSessionView):
    - Exibe ExerciseSessionCard do primeiro exerc√≠cio
    - Exibe primeiro SetCard j√° iniciado para input de peso e repeti√ß√µes.

### 2. **In√≠cio do Exerc√≠cio**

- Quando novo exerc√≠cio √© iniciado (normal ou por troca de ordem):
    - StartExerciseUseCase.swift
        - Cria CDCurrentExercise, atualiza contexto/session
        - Inicia cron√¥metro do exerc√≠cio (TimerService)
    - StartSetUseCase.swift √© chamado imediatamente para iniciar a primeira s√©rie do novo exerc√≠cio
    - UI atualiza ExerciseSessionCard com dados do novo exerc√≠cio e primeira s√©rie aberta para input

### 3. **In√≠cio do S√©rie**

    - Quando um novo exerc√≠cio √© iniciado (automaticamente no in√≠cio do treino ou manualmente durante a execu√ß√£o), o sistema inicia **automaticamente a primeira s√©rie** do exerc√≠cio. Isso garante que **sempre exista ao menos um SetCard vis√≠vel na UI**, representando a primeira s√©rie em andamento.

    - Para a primeira s√©rie:
        - `StartSetUseCase.swift` √© executado:
            - Cria `CDCurrentSet` com `order = 1` e status inicial (n√£o finalizada).
            - Persiste dados b√°sicos da s√©rie.
            - Inicia o cron√¥metro da s√©rie no `TimerService.swift`.
            - Ativa sensores no `MotionManager.swift` e captura de heart rate/calorias pelo `HealthKitManager.swift`.
        - A UI exibe o primeiro `SetCard` no `ExerciseSessionCard`, permitindo que o usu√°rio configure os detalhes antes de executar a s√©rie:
            - Pode editar o peso desejado.
            - Pode definir a meta de repeti√ß√µes (`targetReps`).
            - Se premium, o campo RC (`actualReps`) √© atualizado automaticamente pelo algoritmo ML √† medida que o usu√°rio executa a s√©rie.
            - Se n√£o-premium, o campo RC permanece sempre como `0` (n√£o exibindo repeti√ß√µes autom√°ticas).

    - Durante esta fase inicial da s√©rie, o sistema n√£o for√ßa a contagem imediata de tempo para analytics ‚Äî o tempo do cron√¥metro j√° est√° rodando, mas a expectativa √© que o usu√°rio configure os campos necess√°rios antes de iniciar fisicamente a execu√ß√£o da s√©rie.

    - Al√©m disso, o usu√°rio pode:
        - Adicionar novas s√©ries a qualquer momento usando o bot√£o ‚ÄúAdicionar S√©rie +‚Äù.
            - Cada clique chama `StartSetUseCase.swift`, criando e exibindo um novo `SetCard` abaixo dos existentes.
            - Para n√£o-premium, o n√∫mero m√°ximo de s√©ries por exerc√≠cio √© 3; ao exceder, a UI exibe um modal/call-to-action para upgrade premium.
        - Editar individualmente os campos de cada s√©rie j√° adicionada (peso, target reps, RC se manual).

    - Ou seja: a primeira s√©rie √© sempre criada e iniciada por padr√£o, mas a UI oferece flexibilidade para o usu√°rio ajustar todos os detalhes antes de efetivamente come√ßar a execu√ß√£o ‚Äî tornando a experi√™ncia fluida e n√£o ‚Äúurgente‚Äù.


### 4. **Execu√ß√£o da S√©rie + Detec√ß√£o Autom√°tica de Fim de S√©rie**

- Durante a s√©rie:
    - MotionManager.swift (Watch): coleta sensores (50Hz), bufferiza, envia chunks (100 amostras) via WatchSessionManager.swift
    - Detec√ß√£o autom√°tica:
        - MotionManager detecta descanso, chama updatePhase(.rest) em WorkoutPhaseManager.swift
        - WorkoutPhaseManager atualiza fase, notifica WatchSessionManager.swift
        - WatchSessionManager envia evento para PhoneSessionManager.swift (iPhone)
        - PhoneSessionManager ‚Üí WorkoutSessionViewModel.swift exibe modal para usu√°rio confirmar fim de s√©rie (ou segue fluxo manual)
    - HealthKitManager.swift: coleta/atualiza heart rate/calorias a cada 2s
    - UI permite editar peso, repeti√ß√µes, finalizar manualmente ou automaticamente a s√©rie

### 5. **Finaliza√ß√£o de S√©rie (Manual ou Autom√°tica) + Loop para Nova S√©rie**

- Uma s√©rie em andamento pode ser finalizada de v√°rias formas, dependendo do contexto e da a√ß√£o do usu√°rio:

‚úÖ **Manual via UI**  
  - O usu√°rio toca no bot√£o de status no `SetCard` (checkmark) para marcar a s√©rie como conclu√≠da manualmente.  
  - Atualiza o status de `CDCurrentSet` para finalizada.  
  - Encerra cron√¥metro da s√©rie no `TimerService.swift`.

‚úÖ **Detec√ß√£o Autom√°tica**  
  - Algoritmo (MotionManager) detecta pausa de movimento.  
  - Dispara modal na UI para o usu√°rio confirmar se terminou.  
  - Se confirmado, atualiza status e encerra a s√©rie.  
  - Inicia o timer de descanso descontando os 10s de espera.

‚úÖ **In√≠cio de Timer de Descanso**  
  - O usu√°rio toca no bot√£o ‚ÄúIniciar Timer‚Äù no `workoutStatusSection`.  
  - A√ß√£o impl√≠cita: considera que o usu√°rio terminou a execu√ß√£o da s√©rie atual.  
  - Atualiza o status da s√©rie no `CDCurrentSet` para finalizada.  
  - Encerra cron√¥metro da s√©rie (`TimerService.swift`) e inicia o cron√¥metro de descanso no mesmo servi√ßo.  
  - Atualiza a UI para estado de descanso.

- Ap√≥s a finaliza√ß√£o da s√©rie, independente do m√©todo:
  - `EndSetUseCase.swift` √© chamado:  
    - Atualiza `CDCurrentSet` para status finalizada (tempor√°rio).  
    - Persiste os dados completos no hist√≥rico criando um novo `CDHistorySet`:  
      - Reps (`targetReps`)  
      - Peso  
      - RC (`actualReps`)  
      - Repeti√ß√µes Processadas (`repsCounterData`)  
      - Dados de sensores brutos  
      - Heart rate/calorias:  
        - Serializa os arrays tempor√°rios (`heartRateTimeline` e `caloriesTimeline`) em JSON convertido para `Data` e preenche os atributos `heartRateData` e `caloriesData`.  
        - Preenche tamb√©m `startTime` e `endTime` com as horas reais da s√©rie.  
    - Encerra o cron√¥metro da s√©rie no `TimerService.swift`.  
    - Remove ou reseta o `CDCurrentSet` para preparar para uma nova s√©rie.  
  - A UI atualiza o `SetCard` para status finalizado (checkmark).

---

### 6. **Troca da Ordem de Exerc√≠cios ‚Äì Reatividade e Pausa/Ativa√ß√£o**

- Usu√°rio reordena exerc√≠cios em exerciseListSection (drag-and-drop):
    - Se houver s√©rie/exerc√≠cio em andamento:
        - UI exibe modal de confirma√ß√£o: "Deseja iniciar outro exerc√≠cio? S√©rie atual ser√° pausada."
        - Se confirmado:
            - Exerc√≠cio/s√©rie ativo √© pausado (status atualizado em CDCurrentExercise/CDCurrentSet)
            - StartExerciseUseCase √© chamado para o exerc√≠cio agora em primeiro na lista
            - StartSetUseCase √© chamado para iniciar a primeira s√©rie do novo exerc√≠cio
            - UI atualiza ExerciseSessionCard para refletir o novo exerc√≠cio e s√©rie
    - Persist√™ncia e l√≥gica garantem continuidade/resumibilidade do exerc√≠cio pausado se usu√°rio retornar depois

### 7. **Finaliza√ß√£o de Exerc√≠cio**

- Quando o exerc√≠cio √© finalizado (todas as s√©ries conclu√≠das ou manualmente):
  - `EndExerciseUseCase.swift` √© chamado:  
    - Atualiza/persiste `CDCurrentExercise` (status, estat√≠sticas, cron√¥metro)  
    - Agrega os dados das s√©ries (`CDHistorySet`) do exerc√≠cio para compor a evolu√ß√£o geral do exerc√≠cio.  
    - Serializa os arrays agregados em JSON convertido para `Data` e preenche os atributos `heartRateData` e `caloriesData` no `CDHistoryExercise`.  
    - Preenche `startTime` e `endTime` com as horas reais do exerc√≠cio.  
  - UI marca exerc√≠cio como conclu√≠do em `exerciseListSection`.  
  - Se houver exerc√≠cios restantes, fluxo segue para o pr√≥ximo automaticamente (`StartExerciseUseCase ‚Üí StartSetUseCase`), sen√£o segue para finaliza√ß√£o de treino.

---

### 8. **Finaliza√ß√£o de Treino**

- Quando o treino √© finalizado:
  - `EndWorkoutUseCase.swift` √© chamado:  
    - Atualiza/persiste `CDCurrentSession` como finalizada.  
    - Calcula estat√≠sticas finais, encerra sensores, timers, HealthKit.  
    - Agrega os dados de todos os `CDHistoryExercise` para compor a evolu√ß√£o geral do treino.  
    - Serializa os arrays agregados em JSON convertido para `Data` e preenche os atributos `heartRateData` e `caloriesData` no `CDWorkoutHistory`.  
    - Preenche `startTime` e `endTime` com as horas reais do treino.  
  - UI exibe resumo/fim de treino.  
  - Contexto final √© sincronizado com Watch (se aplic√°vel).

## üìà Atualiza√ß√£o do `HealthKitManager.swift`

- Respons√°vel tamb√©m por configurar e gerenciar:
  - `HKAnchoredObjectQuery` para capturar `heartRate` (BPM) continuamente, convertendo `HKQuantity` para count/min.
  - `HKLiveWorkoutBuilder` + `HKLiveWorkoutDataSource` para monitorar `activeEnergyBurned` (kcal) continuamente.
- Ambos os fluxos escrevem em arrays tempor√°rios em mem√≥ria com a estrutura:

```swift
struct MetricSample {
    let timestamp: Double // segundos desde startTime do n√≠vel
    let value: Double
}
```
- Arrays tempor√°rios durante o treino:
  - heartRateTimeline: [MetricSample]
  - caloriesTimeline: [MetricSample]

### üì¶ Persist√™ncia no Core Data

- Ao finalizar cada n√≠vel (s√©rie, exerc√≠cio ou treino), os arrays tempor√°rios s√£o serializados para JSON e armazenados nos seguintes n√≠veis:
  - `CDHistorySet`
  - `CDHistoryExercise`
  - `CDWorkoutHistory`

- Formato do JSON salvo nos atributos bin√°rios:

```json
{
  "startTime": "2025-07-17T14:30:00Z",
  "samples": [
    { "timestamp": 0.0, "value": 123 },
    { "timestamp": 1.0, "value": 124 }
  ]
}
```

- `startTime` √© a hora real (Date) de in√≠cio do n√≠vel correspondente.
- `timestamp` √© o n√∫mero de segundos decorridos desde `startTime`.

- Atributos persistidos nas entidades:

```swift
@NSManaged var startTime: Date?
@NSManaged var endTime: Date?
@NSManaged var heartRateData: Data?
@NSManaged var caloriesData: Data?
```

- Definidos com `allowsExternalBinaryDataStorage = YES`.
- O `WorkoutDataService` √© respons√°vel por serializar/deserializar os arrays tempor√°rios e armazenar/ler os bin√°rios para hist√≥rico.

## Fluxo T√©cnico de Dados e Pipeline de Capta√ß√£o

[Watch: MotionManager.swift] (captura, chunking) 
    ‚Üí [WatchSessionManager.swift] (envio) 
    ‚Üí [PhoneSessionManager.swift] (recebe, processa) 
    ‚Üí [UpdateDataToMLUseCase.swift] (orquestra processamento) 
    ‚Üí [MLModelManager.swift] (ML, rep counting)
    ‚Üí [WorkoutSessionViewModel.swift] (estado reativo, publishers)
    ‚Üí [WorkoutSessionView.swift] (UI, gr√°ficos, feedback)
    ‚Üî [CoreDataAdapter.swift] / [WorkoutDataService.swift] (persist√™ncia)
    ‚Üí [SubscriptionManager.swift] (controle premium/free via publishers)
    ‚Üí [LocationManager.swift] (localiza√ß√£o opcional)
    ‚Üí [HealthKitManager.swift] (heart rate/calorias, captura e envio)


### üóÑÔ∏è Estrutura CoreData para Sensores, ML e Hist√≥rico

O sistema utiliza entidades tempor√°rias (`CDCurrent*`) durante o treino ativo e migra os dados para entidades hist√≥ricas (`CDHistory*`) ao final de cada s√©rie, exerc√≠cio ou treino.  
A persist√™ncia √© resiliente: suporta downgrade (premium ‚Üí free) e upgrade (free ‚Üí premium) sem perda de dados.

---

### üìä Entidades Tempor√°rias (durante o treino ativo)

- **`CDCurrentSession`**
  - Sess√£o ativa do treino.
  - Relaciona-se com exerc√≠cios e s√©ries atuais.
  - Armazena: in√≠cio, localiza√ß√£o opcional, cron√¥metro global, status atual.

- **`CDCurrentExercise`**
  - Exerc√≠cio ativo atual.
  - Relacionado √†s s√©ries desse exerc√≠cio.
  - Guarda: nome, ordem, status parcial, cron√¥metro do exerc√≠cio.

- **`CDCurrentSet`**
  - S√©rie do exerc√≠cio ativo.
  - Armazena:
    - `order`: n√∫mero da s√©rie
    - `weight`: peso definido
    - `targetReps`: objetivo de repeti√ß√µes
    - `actualReps`: detectadas manualmente ou via ML
    - `status`: finalizada/n√£o finalizada
  - Durante execu√ß√£o, a timeline (`repsCounterData`) e os sensores brutos (`sensorData`) ficam em **cache na mem√≥ria**.
  - Durante execu√ß√£o, tamb√©m ficam em cache os arrays de m√©tricas card√≠acas e cal√≥ricas:
    - `heartRateTimeline: [MetricSample]`
    - `caloriesTimeline: [MetricSample]`

---

### ü™µ Entidades Hist√≥ricas (ap√≥s finaliza√ß√£o)

Quando uma s√©rie, exerc√≠cio ou treino √© conclu√≠do, os dados s√£o migrados para as entidades hist√≥ricas:

- **`CDHistorySession`**
  - Sess√£o completa no hist√≥rico.
  - Inclui: informa√ß√µes globais, localiza√ß√£o (se permitida), permiss√µes no momento da conclus√£o.

- **`CDHistoryExercise`**
  - Exerc√≠cios finalizados da sess√£o.
  - Relacionado √†s s√©ries conclu√≠das.
  - Armazena evolu√ß√£o agregada das m√©tricas card√≠acas e cal√≥ricas serializadas.

- **`CDHistorySet`**
  - S√©ries finalizadas.
  - Salva todos os detalhes:
    - `actualReps`
    - `weight`, `targetReps`, `order`
    - `repsCounterData`: JSON da timeline do movimento detectado pelo ML.
    - `heartRateData`: batimentos ao longo da s√©rie (JSON serializado em `Data`).
    - `caloriesData`: calorias gastas (JSON serializado em `Data`).
    - `sensorData`: chunks brutos (opcional, para an√°lise).

---

### üìà Captura de Frequ√™ncia Card√≠aca e Calorias

Durante o treino ativo:
- `HealthKitManager` inicia:
  - `HKAnchoredObjectQuery` para capturar `heartRate` (BPM) continuamente.
  - `HKLiveWorkoutBuilder` com `HKLiveWorkoutDataSource` para `activeEnergyBurned` (kcal) continuamente.
- Ambas as m√©tricas alimentam arrays tempor√°rios em mem√≥ria com a seguinte estrutura:

```swift
struct MetricSample {
    let timestamp: Double // segundos desde startTime do n√≠vel
    let value: Double
}
```

Ao finalizar um n√≠vel (s√©rie, exerc√≠cio ou treino), os arrays s√£o serializados em JSON e salvos nos atributos bin√°rios correspondentes, junto a startTime e endTime.

### üåü Upgrade Premium

- Todos os dados detalhados s√£o sempre coletados e salvos, independentemente do status premium.
- Para usu√°rios free, a UI n√£o exibe a contage de Repeti√ß√µes (RC) e nem gr√°ficos/timelines detalhados.
- Upgrade premium d√° **acesso imediato** a todo hist√≥rico detalhado j√° salvo.

---

### üõ°Ô∏è Persist√™ncia Resiliente

- Projetada para manter integridade mesmo com mudan√ßas de permiss√µes:
  - Downgrade: apenas oculta visualiza√ß√£o premium, dados permanecem.
  - Upgrade: libera acesso instant√¢neo.
- Campos opcionais (como repsCounterData, heartRateData, caloriesData) s√£o preenchidos quando poss√≠vel.
- O sistema nunca descarta dados coletados.

---

### üìä Visualiza√ß√£o no Hist√≥rico

- Na visualiza√ß√£o hist√≥rica:
  - Os bin√°rios (heartRateData e caloriesData) s√£o deserializados para reconstruir os arrays [MetricSample] para cada n√≠vel.
  - A UI exibe gr√°ficos de linha mostrando a evolu√ß√£o ao longo de:
    - Cada s√©rie (CDHistorySet)
    - Cada exerc√≠cio (CDHistoryExercise)
    - Treino completo (CDWorkoutHistory)
  - M√©tricas exibidas: Frequ√™ncia card√≠aca (BPM) e Calorias gastas (kcal).

### Resumo

| Entidade             | Quando √© usada    | O que cont√©m                                               |
|----------------------|-------------------|------------------------------------------------------------|
| `CDCurrentSession`   | Durante treino    | Sess√£o ativa, status global, link com exerc√≠cios.          |
| `CDCurrentExercise`  | Durante treino    | Exerc√≠cio ativo, status, link com s√©ries.                  |
| `CDCurrentSet`       | Durante treino    | S√©rie ativa, b√°sicos (`weight`, `targetReps`, `actualReps`)|
| `CDHistorySession`   | Hist√≥rico         | Sess√£o finalizada, localiza√ß√£o, permiss√µes no momento.     |
| `CDHistoryExercise`  | Hist√≥rico         | Exerc√≠cios finalizados com status e s√©ries.                |
| `CDHistorySet`       | Hist√≥rico         | S√©ries finalizadas com todos os detalhes, incluindo ML.    |

## Observa√ß√µes Finais

- In√≠cio do treino SEMPRE executa em sequ√™ncia: StartWorkoutUseCase ‚Üí StartExerciseUseCase ‚Üí StartSetUseCase para o primeiro exerc√≠cio/s√©rie da lista atual.

- Mudan√ßas de ordem na exerciseListSection pausam exerc√≠cio/s√©rie ativo, atualizam o card da currentExerciseSection e iniciam o exerc√≠cio que ficou em primeiro na lista.

- L√≥gica reativa: qualquer altera√ß√£o (ordem, entrada manual, conclus√£o autom√°tica, premium, hardware) √© refletida instantaneamente na UI e sincronizada via ViewModel/UseCases.

- Todo o pipeline, desde sensores at√© persist√™ncia, est√° desacoplado, resiliente e preparado para expans√£o futura.

# WorkoutSessionView ‚Äì Estrutura de UI e L√≥gica de In√≠cio do Treino

---

## Estrutura de `WorkoutSessionView`

A `WorkoutSessionView` √© a tela principal para acompanhamento e execu√ß√£o do treino ativo.  
Sua estrutura √© dividida em quatro se√ß√µes principais, compondo uma experi√™ncia flex√≠vel, responsiva e personaliz√°vel para cada usu√°rio.

---

### 1. **headerSection**

- **Bot√£o Voltar (esquerda):**
  - Retorna para `HomeView`
  - Mant√©m o treino ativo ao sair da tela

- **T√≠tulo Central:**
  - Exibe o nome do treino (`autoTitle` de `CDWorkoutPlan` selecionado)
  - Din√¢mico, refletindo sempre o plano iniciado

- **Bot√£o Configura√ß√£o (`ellipsis.circle.fill`, direita):**
  - Abre sheet/modal de configura√ß√£o r√°pida do treino (ex: definir s√©ries padr√£o por exerc√≠cio, editar plano)
  - Permite ao usu√°rio personalizar detalhes do treino a qualquer momento

---

### 2. **workoutStatusSection**

- **WorkoutStatusCard:**
  - Relat√≥rio geral do treino ativo:
    - Nome do treino
    - Grupos musculares
    - Progresso do treino (exerc√≠cios/s√©ries)
    - Cron√¥metro global (tempo total da sess√£o, controlado por `TimerService.swift`)
    - Calorias gastas totais (dados de `HealthKitManager.swift`)
    - Heart rate ao vivo (dados de `HealthKitManager.swift`)
  - **Diferen√ßa de contexto:**
    - Na `HomeView.swift` (estado ‚ÄúActiveWorkout‚Äù): exibe bot√£o ‚ÄúVer‚Äù ao lado do nome do treino, levando √† `WorkoutSessionView`
    - Na `WorkoutSessionView.swift`: esse bot√£o √© ocultado

- **Bot√µes de A√ß√£o (abaixo do card):**
  - **PAUSAR:** Pausa o cron√¥metro global do treino
  - **FINALIZAR:** Finaliza imediatamente o treino ativo
  - Ambos na mesma linha para acesso r√°pido

- **Bot√£o "INICIAR TIMER":**
  - Abaixo dos bot√µes principais
  - Inicia timer de descanso padr√£o (1:30 min por default)
  - A√ß√£o r√°pida para intervalos/pausas durante o treino

---

### 3. **currentExerciseSection**

- **ExerciseSessionCard:**
  - Card din√¢mico para o exerc√≠cio atual (determinado pela ordem em `exerciseListSection`)
  - Exibe:
    - Nome do exerc√≠cio atual
    - Lista de SetCards (s√©ries) definidas pelo usu√°rio (m√≠nimo 1)
  - **SetCard (dentro de ExerciseSessionCard):**
    - N√∫mero da s√©rie (reflete atributo `order` em `CDCurrentSet`)
    - Campo Peso (edit√°vel, salva em `weight` de `CDCurrentSet`)
    - Campo Repeti√ß√µes (edit√°vel, salva em `targetReps` de `CDCurrentSet`)
    - Campo RC (Reps Counter, edit√°vel, salva em `actualReps` de `CDCurrentSet`)
    - Campo Status (bot√£o c√≠rculo):
      - Vazio = n√£o finalizada
      - Preenchido + checkmark = s√©rie finalizada (manual ou autom√°tica)
      - Clique encerra a s√©rie (atualiza status/persist√™ncia)
  - **Bot√£o "Adicionar S√©rie +":**
    - Sempre vis√≠vel abaixo da √∫ltima s√©rie
    - Adiciona nova s√©rie (limitado a 3 para n√£o-premium; ilimitado para premium)
    - Exibe modal/call-to-action ao exceder o limite para n√£o-premium

---

### 4. **exerciseListSection**

- Lista todos os exerc√≠cios do treino
- **Cards de exerc√≠cios (`ExerciseCard.swift`):**
  - Separa√ß√£o entre exerc√≠cios conclu√≠dos e ativos
  - Exerc√≠cio ativo √© destacado
  - **Drag-and-drop** habilitado para reordenar exerc√≠cios n√£o conclu√≠dos
    - Exige confirma√ß√£o se houver s√©rie em andamento (exibe modal: ‚ÄúIniciar outro exerc√≠cio? S√©rie atual ser√° pausada‚Äù)
    - Troca r√°pida pausa o exerc√≠cio atual, inicia o novo selecionado

---

## **L√≥gica de In√≠cio e Controle do Treino**

### 1. **In√≠cio do Treino**

- Usu√°rio clica em "Iniciar Treino":
  - Pode ser pelo card principal (`WorkoutStatusCard` em estado `NextWorkout` na `HomeView.swift`)
  - Ou pelo card do treino (`WorkoutPlanCard.swift` em `HomeView.swift` ou `WorkoutView.swift`)
- No Watch, l√≥gica equivalente: treino iniciado diretamente exibe o primeiro exerc√≠cio e primeira s√©rie
- **Imediatamente:**
  - Primeiro exerc√≠cio da lista (`exerciseListSection`) √© exibido no `ExerciseSessionCard`
  - Primeira s√©rie do exerc√≠cio j√° √© iniciada, aguardando input do usu√°rio

### 2. **Durante a S√©rie**

- Usu√°rio pode inserir peso, repeti√ß√µes e RC (reps counter) manualmente ou por detec√ß√£o autom√°tica (premium)
- Pode clicar no bot√£o de configura√ß√£o (ellipsis) a qualquer momento para definir n√∫mero padr√£o de s√©ries
- Pode usar bot√£o "Adicionar S√©rie +" para inserir mais s√©ries (respeita limites premium)

### 3. **Troca de Exerc√≠cio**

- Usu√°rio pode reordenar a lista via drag-and-drop (`exerciseListSection`)
  - Se tentar come√ßar outro exerc√≠cio com uma s√©rie em andamento, exibe modal de confirma√ß√£o:
    - ‚ÄúDeseja iniciar outro exerc√≠cio? S√©rie atual ser√° pausada.‚Äù
  - Se confirmado:
    - Exerc√≠cio ativo fica pausado (status persistido)
    - Novo exerc√≠cio selecionado √© exibido no `ExerciseSessionCard`
    - Primeira s√©rie do novo exerc√≠cio √© iniciada

### 4. **Finaliza√ß√£o e Loop de S√©ries**

- A cada finaliza√ß√£o de s√©rie:
  - Marca a s√©rie como conclu√≠da (manual ou automaticamente, bot√£o checkmark)
  - Se h√° s√©ries restantes ou usu√°rio adiciona nova, repete loop (nova s√©rie iniciada)
  - Ao finalizar todas as s√©ries ou usu√°rio clicar ‚ÄúFinalizar Exerc√≠cio‚Äù, parte para o pr√≥ximo exerc√≠cio
  - Usu√°rio pode navegar livremente entre exerc√≠cios n√£o conclu√≠dos (com modais de confirma√ß√£o)
- Ao finalizar todos os exerc√≠cios, fluxo finaliza o treino

---

## **Refer√™ncia de Arquivos na View**

- **WorkoutSessionView.swift:** Composi√ß√£o da tela, integra√ß√£o com ViewModel, gerenciamento de navega√ß√£o e intera√ß√£o UI.
- **WorkoutSessionViewModel.swift:** Estado da UI, publishers, l√≥gica de exibi√ß√£o/habilita√ß√£o de bot√µes e limites premium.
- **WorkoutStatusCard.swift:** Card de status e relat√≥rios do treino.
- **ExerciseSessionCard.swift:** Card do exerc√≠cio atual, lista din√¢mica de SetCards.
- **SetCard.swift:** Cada s√©rie do exerc√≠cio, inputs edit√°veis, status e checkmark.
- **ExerciseCard.swift:** Cards da lista de exerc√≠cios, suporte a drag-and-drop.
- **HomeView.swift/WorkoutView.swift:** Fluxo de navega√ß√£o e sele√ß√£o de treinos.
- **WorkoutPlanCard.swift:** Card dos planos na Home/WorkoutView, inicia o fluxo ao tocar.

---

## **Observa√ß√µes T√©cnicas**

- Todos os dados editados/refletidos nos cards de s√©rie s√£o sincronizados com CoreData via ViewModel/UseCases.
- Limites premium (n√∫mero de s√©ries) s√£o controlados na ViewModel, exibindo modais/call-to-action ao atingir o m√°ximo.
- Troca de exerc√≠cios ativa persist√™ncia de status atual antes da transi√ß√£o.
- UI e ViewModel sempre reagem a permiss√µes premium (RevenueCat/publishers).
- Permiss√µes de hardware (HealthKit, localiza√ß√£o) afetam status dos cards em tempo real.
- Cron√¥metros, timers e progresso s√£o sempre controlados e exibidos pelo `TimerService.swift`.

---

> **Este design garante UX intuitiva, performance, flexibilidade para upgrades, e arquitetura escal√°vel para manuten√ß√£o futura.**
